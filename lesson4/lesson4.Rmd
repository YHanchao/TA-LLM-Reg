---
title: "第四次习题课"
author: "Hong Chang"
date: "2025-03-08"
output: html_document
---

# 使用LLM辅助R语言编程

事前准备：
大语言模型，示例：[通义千问](https://tongyi.aliyun.com/)


大语言模型的Prompt通常是下面的结构

1. （可选）定义身份：你是一名专业的数据科学家，我是零代码基础的用户。
2. 定义任务：我将提供给你一份CSV格式的数据集（文件名：第二章.csv），数据集使用了GBK编码，请你使用R语言代码读取数据，这段代码能够【......】，并以较美观的方式输出。由于我是零代码基础的用户，你应当使用尽可能容易理解的代码，尽量避免引入不必要的包，代码应当有详细的注释。
3. （可选）示例输入：（这个案例中我们不需要提供输入定义）
4. （可选）示例输出：你的结果应当以Code Block的形式输出，无需其他输出（并尝试处理csv中的数据，输出结果，方便我查看）。

## 任务一：变量处理
**输入PROMPT**：你是一名专业的数据科学家，我是零代码基础的用户。我将提供给你一份CSV格式的数据集（文件名：第2章.csv），数据集使用了GBK编码，请你使用R语言代码读取数据，我想分析北京二手房房价影响因素，请将price变量对数化后存储为新变量y。你的结果应当以Code Block的形式输出，无需其他输出。

**LLM输出**

```{r}
library(readr)
library(dplyr)
# 读取CSV文件，注意设置正确编码为GBK
data <- read_csv("第2章.csv", locale = locale(encoding = "GBK"))

# 创建新的对数化房价变量y
data <- data %>% mutate(y = log(price))

# 查看前几行数据确认新变量已添加
# head(data)
```

## 任务二：描述统计【plus版】：针对离散的X变量结合Y变量（对数变换后的房屋价格）做描述统计

**输入PROMPT**：我想针对离散的X变量结合Y变量做描述统计。请写一个函数，输入为离散的自变量名，输出为该变量和因变量（Y）关系的描述性统计量。请结合输入的离散变量对Y分组，分别计算各组样本量，均值，标准差，最小值，中位数，最大值。

**LLM输出**

```{r}
calculate_descriptive_stats <- function(data, discrete_var) {
  # 确认数据中存在指定的离散变量和因变量y
  if (!discrete_var %in% names(data) || !'y' %in% names(data)) {
    stop('Specified variable name is not in the data or missing dependent variable y')
  }
  
  # 使用dplyr包进行数据操作
  library(dplyr)
  
  # 计算描述性统计量
  stats <- data %>%
    group_by(.data[[discrete_var]]) %>%
    summarise(
      n = n(),
      mean = mean(y, na.rm = TRUE), sd = sd(y, na.rm = TRUE),
      min = min(y, na.rm = TRUE),median = median(y, na.rm = TRUE),
      max = max(y, na.rm = TRUE)
    )
  
  return(stats)
}
# 示例调用：
# 假设data是你的数据框，"district"是你想分析的离散自变量
# calculate_descriptive_stats(data, "district")
```

## 任务三：模型选择

**输入PROMPT**：请你使用R建立线性回归模型，以“y”为因变量，自变量中考虑“district”和“subway”的交互作用，以及“area”，“floor”,并考虑将“bedrooms”、“halls”作为类别变量加入模型，并输出回归模型的详细结果。请你使用尽可能容易理解的代码、尽量避免引入不必要的包，代码应当有详细的注释。你的结果应当以Code Block的形式输出，无需其他输出。

**LLM输出**

```{r}
# 将bedrooms和halls转换为因子（类别变量）
data$bedrooms <- as.factor(data$bedrooms)
data$halls <- as.factor(data$halls)

# 建立线性回归模型
# 公式解释：y ~ area + floor + district:subway + bedrooms + halls
# 这里考虑了district和subway的交互作用，并将bedrooms和halls作为类别变量加入模型
model <- lm(y ~ area + floor + district * subway + bedrooms + halls, data = data)

# 输出回归模型的详细结果
summary(model)

# 注意：
# 1. 确保所有变量名正确无误地反映在模型公式中。
# 2. 如果某些变量不存在或者名称不同，请根据实际情况调整代码中的变量名。
# 3. 此处使用的lm函数是R的基础包stats的一部分，不需要额外安装。
# 4. `district * subway` 表示同时包含district和subway主效应以及它们之间的交互作用。

```

**输入PROMPT**：对于刚刚建立的模型，如果我考虑删去代表客厅数目的“halls”变量，请帮我建立一个新模型，你的结果应当以Code Block的形式输出，无需其他输出。

**LLM输出**
```{r}
# 将bedrooms和halls转换为因子（类别变量）
data$bedrooms <- as.factor(data$bedrooms)

# 建立线性回归模型
# 公式解释：y ~ area + floor + district:subway + bedrooms
# 这里考虑了district和subway的交互作用，并将bedrooms和halls作为类别变量加入模型
model_new <- lm(y ~ area + floor + district * subway + bedrooms, data = data)

# 输出回归模型的详细结果
summary(model_new)

# 注意：
# 1. 确保所有变量名正确无误地反映在模型公式中。
# 2. 如果某些变量不存在或者名称不同，请根据实际情况调整代码中的变量名。
# 3. 此处使用的lm函数是R的基础包stats的一部分，不需要额外安装。
# 4. `district * subway` 表示同时包含district和subway主效应以及它们之间的交互作用。
```

**输入PROMPT**：请你使用R语言对刚刚建立的两个模型进行方差分析，来分析客厅数目这个变量是否重要。你的结果应当以Code Block的形式输出，并通过注释告诉我如何解读结果。

**LLM输出**
```{r}
# 对两个模型进行方差分析，以评估'halls'变量的重要性
# 执行ANOVA检验，比较包含和不包含'halls'变量的模型
anova_result <- anova(model, model_new)

# 输出方差分析结果
print(anova_result)

# 注释：
# - 'anova' 函数用于执行方差分析（ANOVA），这里比较了两个模型(model 和 new_model)。
# - 结果中的'Pr(>F)'列提供了p值，它用于检验两个模型之间的差异是否具有统计学意义。
# - 如果'Pr(>F)'小于0.05，通常认为两个模型之间存在显著性差异，说明被移除的变量('halls')对模型有显著影响。
# - 若'Pr(>F)'大于0.05，则表明移除'halls'变量并未显著降低模型的拟合优度，暗示'halls'可能不是预测'y'的重要因素。
```


**输入PROMPT**：请你使用R语言建立第三个模型，它包括所有自变量但是不涉及变量间的交互作用。你的结果应当以Code Block的形式输出。

**LLM输出**
```{r}
# 创建第三个线性回归模型，包含所有自变量但不涉及交互作用
# 将bedrooms和halls作为因子（类别变量）处理
data$bedrooms <- as.factor(data$bedrooms)
data$halls <- as.factor(data$halls)

# 创建新的线性回归模型，包含'district', 'subway', 'area', 'floor', 'bedrooms', 'halls'作为自变量，但是不包括任何交互作用项
model_3 <- lm(y ~ district + subway + area + floor + bedrooms + halls, data = data)

# 输出回归模型的详细结果
summary(model_3)
# 注释：
# - 在这个模型中，我们包含了所有指定的自变量，但是没有考虑交互作用（即没有使用如district * subway这样的交互项）。
# - 这有助于理解每个自变量对因变量'y'的影响，而不考虑变量之间的相互作用影响。
# - 使用'summary(model_3)'来查看模型的详细输出，包括系数估计、标准误差等信息。
```

**输入PROMPT**：请你使用R语言检验全模型model的变量间的共线性，例如计算变量们的VIF，你的结果应当以Code Block的形式输出，并通过注释告诉我如何解读结果。

**LLM输出**
```{r}
# 加载必要的R包
if (!require(car)) install.packages("car"); library(car)

# 计算全模型model的变量VIF值
vif_values <- vif(model)

# 输出VIF值
print(vif_values)

# 注释：
# - VIF（方差膨胀因子）用于检测多元回归模型中自变量之间的多重共线性。
# - 一般规则是：VIF值越接近1，表明该自变量与其他自变量的相关性越小；如果VIF超过5或10，则表示存在较高的多重共线性问题。
# - 如果某个变量的VIF值非常高，可能需要考虑从模型中移除这个变量，或者寻找其他方法来解决多重共线性的问题（如岭回归、主成分回归等）。
# - 在这里，我们通过'vif'函数对全模型'model'进行了分析，并打印出每个自变量的VIF值。
```



**输入PROMPT**：请你使用R语言对的没有交互作用的全模型model利用双向逐步回归方法进行以AIC为选择标准的模型选择，来寻找最好的子模型。你的结果应当以Code Block的形式输出，并通过注释告诉我如何解读结果。

**LLM输出**
```{r}
# 加载必要的R包
if (!require(MASS)) install.packages("MASS"); library(MASS)

# 使用stepAIC函数进行双向逐步回归，以AIC作为选择标准
best_model <- stepAIC(model, direction="both")

# 输出最佳子模型的详细结果
summary(best_model)

# 注释：
# - 'stepAIC' 函数来自'MASS'包，用于执行基于AIC（赤池信息准则）的逐步回归分析。
# - 'direction="both"' 参数指定了使用双向逐步回归方法，这意味着既可以添加也可以删除变量来优化模型。
# - 逐步回归的目标是找到AIC值最小的模型，即在模型复杂度和拟合优度之间取得最佳平衡的最佳子模型。
# - 最终输出的'best_model'是经过逐步回归选择后的最佳模型。通过'summary(best_model)'可以查看该模型的具体信息，
#   包括保留下来的自变量及其对应的系数估计、显著性水平等。
# - 比较原始模型'model_3'和'best_model'可以帮助我们了解哪些变量对模型预测'y'最为关键，以及这些变量如何影响'y'。
```

## 任务四：模型预测
**输入PROMPT**：请你使用R语言利用刚刚找到的最好模型帮我进行预测，案例中在西城区上学，想买一套邻近地铁的两室一厅二手房，面积是85平方米，低层楼层，即令“district”为“西城”，“bedrooms”为2，“halls”为1，“floor”为“low”，“subway”和“school”都为1，“area”为85，那么房价大约是多少呢？请注意目前的y表示的是房子每平方米的均价的对数值，请帮我换算为实际总价。

**LLM输出**

```{r}
# 假设best_model是通过前面步骤找到的最佳子模型

# 创建新的数据框，包含预测案例的信息
new_data <- data.frame(
  district = "西城",
  subway = 1,
  area = 85,
  floor = "low",
  bedrooms = as.factor(2),
  halls = as.factor(1),
  school = 1
)

# 对新数据进行预测，得到每平方米均价的对数值
predicted_log_price_per_sqm <- predict(best_model, newdata = new_data)

# 将对数值转换为原始价格（每平方米均价）
predicted_price_per_sqm <- exp(predicted_log_price_per_sqm)

# 计算总价
total_price <- predicted_price_per_sqm * new_data$area

# 输出预测的总价
print(total_price)
```
